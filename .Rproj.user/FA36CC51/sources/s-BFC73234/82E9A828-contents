
library(glmmTMB)
library(tidyr)
library(dplyr)
library(ecoCopula)

# read in data
compo <- read.csv("data/derived/composition_data_long.csv") %>% 
  mutate(fire_treatment = ifelse(fire_treatment == "b" &  Time_pt  <= 6, "ub",fire_treatment)) %>% 
  mutate(water_treatment = factor(water_treatment, levels = c("H", "M", "L"))) %>% 
  mutate(fire_treatment = factor(fire_treatment, levels = c("ub","b")))

#read in treatment
treatment <- read.csv("data/water_fire_treatment.csv") %>% 
  select(Sod,water_treatment, fire_treatment, veg) %>% 
  mutate(Swamp = substr(Sod, 1,2)) 



baum_rubi_dt <- compo %>% 
  filter(Species == "Baum rubi") 



ggplot(baum_rubi_dt, aes(x = Time_pt, y=PA, fill = water_treatment, color = water_treatment)) + 
  theme_classic()+
  geom_smooth(se= FALSE)+
  facet_grid(veg~fire_treatment)+
  theme(legend.position = "bottom")

baum_rubi_sum  = baum_rubi_dt %>% 
  group_by(Time_pt,water_treatment,fire_treatment,veg) %>% 
  summarise(p = mean(PA))


ggplot(baum_rubi_sum, aes(x = Time_pt, y=p, fill = water_treatment, color = water_treatment)) + 
  theme_classic()+
  geom_point()+
  geom_line()+
  facet_grid(veg~fire_treatment)+
  theme(legend.position = "bottom")


# extract a particular time point
PA_df6 <- compo %>% 
  filter(Time_pt == 9) %>% 
  pivot_wider(names_from = Species, values_from = PA, id_cols = Sod) 

# enviro data
Enviro <- left_join(PA_df6[,1],treatment) 

#remove sods and species with few presences
n_pres_col <- apply(PA_df6[,-1],2,sum)
keep_sp = names(n_pres_col[n_pres_col>5])
n_pres_row <- apply(PA_df6[,-1],1,sum)
PA_alsp <- as.matrix(PA_df6[,-1])
rownames(PA_alsp) <- PA_df6$Sod
PA <- PA_alsp[n_pres_row>4, colnames(PA_alsp) %in% keep_sp]
Enviro <- Enviro[n_pres_row>4,]

# control for veg and swamp, ordination
veg_swamp_mod <- stackedsdm(PA, formula_X =  ~ veg*Swamp, data = Enviro, family = "binomial")
veg_swamp_ord <- cord(veg_swamp_mod, n.samp = 1000)

#colour by water
water=ifelse(Enviro$water_treatment  == "H", "black",
             ifelse(Enviro$water_treatment  == "M", "forestgreen","red"))
plot(veg_swamp_ord, site.col=water, site.text = TRUE)

# colour by fire
fire=ifelse(Enviro$fire_treatment  == "b", "black","red")
plot(water_ord, site.col=fire, site.text = TRUE)

# control for veg, swamp and water
ex_fire_mod <- stackedsdm(PA, formula_X =  ~ veg*Swamp*water_treatment, data = Enviro, family = "binomial")
ex_fire_ord <- cord(ex_fire_mod, n.samp = 1000)

# colour by fire
plot(ex_fire_ord, site.col=fire, site.text = TRUE)




library(vegan)
ord <- metaMDS(PA)
plot(ord, type = "t")


library(gllvm)
fitRand <- gllvm(PA,formula_X =  ~ veg*Swamp*water_treatment, data = Enviro,  family = "binomial")#, 
ordiplot(fitRand, biplot = FALSE, s.colors = fire)
